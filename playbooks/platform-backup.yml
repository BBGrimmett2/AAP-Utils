# Arhcitecture conditions
---
- name: Backup AAP Platform
  hosts: automationutility
  vars:
    installer_dir: /opt/ansible/installer/aap-2.6.1-containerized
    backup_base_dir: /opt/ansible/backups/
    backup_dir: "{{ backup_base_dir }}/{{ ansible_date_time.iso8601_basic_short }}"
    inventory_path: /opt/ansible/installer/aap-2.6.1-containerized/inventory-growth
    retention_days: 0
  tasks:
    # - name: Create AAP platform backup
    #   ansible.builtin.shell: >
    #     cd {{ installer_dir }} && ansible-playbook -i {{ inventory_path }} ansible.containerized_installer.backup -e backup_dir={{ backup_dir }}
    #   register: backup_result

    # - name: Assert backup command ran successfully
    #   ansible.builtin.assert:
    #     that:
    #       - backup_result.rc == 0
    #       - "'failed=0' in backup_result.stdout"
    #     fail_msg: >
    #       Backup failed. Return code={{ backup_result.rc }},
    #       output={{ backup_result.stdout_lines | select('search', 'failed') | list }}
    #     success_msg: "AAP backup completed successfully"
      
    - name: Find Backup Directories
      ansible.builtin.find:
        paths: "{{ backup_base_dir }}"
        file_type: any
        depth: 1
      register: found_backups
  
    - name: Compute retention time cutoff
      ansible.builtin.set_fact:
       cutoff_epoch: "{{ (ansible_date_time.epoch | int) - ((retention_days | int) * 86400) }}"

    - name: Remove entries older than retention period
      vars:
        name: "{{ entry.path | basename }}"
        # exact match like 20251104T081338
        stamp_str: "{{ name | regex_search('^[0-9]{8}T[0-9]{6}$') | default('') }}"
        stamp_dt: "{{ stamp_str | to_datetime('%Y%m%dT%H%M%S') if stamp_str | length > 0 else None }}"
        dir_epoch: >-
          {% if stamp_dt is not none %}
          {{ (stamp_dt | to_timestamp | default(stamp_dt | community.general.to_epoch)) | int }}
          {% else %}0{% endif %}
      ansible.builtin.file:
        path: "{{ entry.path }}"
        state: absent
      loop: "{{ found_backups.files }}"
      loop_control:
        loop_var: entry
        label: "{{ entry.path }}"
      when:
        - stamp_str | length > 0
        - (dir_epoch | int) > 0
        - (dir_epoch | int) < (cutoff_epoch | int)